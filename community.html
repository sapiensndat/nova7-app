<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Hub - nova7</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* ... (Your existing CSS styles remain unchanged) ... */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F3F2EF;
            color: #1D2026;
        }
        /* Sidebar Styles */
        .sidebar-nova7 {
            background-color: #004182;
            color: #E0F2FE;
            width: 260px;
            box-shadow: 2px 0 8px rgba(0,0,0,0.1);
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            padding-top: 1.5rem;
            transition: transform 0.3s ease-in-out;
            z-index: 40;
            display: flex;
            flex-direction: column;
        }
        .sidebar-header {
            padding: 0 1.5rem 1rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid #0053a0;
            margin-bottom: 0.75rem;
        }
        .nova7-logo-header {
            max-height: 36px;
            width: auto;
        }
        .sidebar-logo-img {
            max-height: 120px;
            width: auto;
        }
        .sidebar-nova7 .nav-link-sidebar {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            margin: 0.25rem 1rem;
            font-weight: 500;
            color: #E0F2FE;
            transition: background-color 0.2s, color 0.2s;
        }
        .sidebar-nova7 .nav-link-sidebar:hover {
            background-color: #0A66C2;
            color: #FFFFFF;
        }
        .sidebar-nova7 .nav-link-sidebar.active {
            background-color: #FFFFFF;
            color: #0A66C2;
            font-weight: 600;
        }
        .sidebar-nova7 .nav-link-sidebar i {
            width: 20px;
            margin-right: 0.75rem;
            text-align: center;
        }
        /* Main Content Styles */
        .main-content-area {
            margin-left: 260px;
            padding: 2rem;
            width: calc(100% - 260px);
            min-height: 100vh;
        }
        .btn-primary-action {
            background-color: #0A66C2;
            color: white;
            border-radius: 8px;
            padding: 0.625rem 1.25rem;
            font-weight: 600;
            transition: background-color 0.2s, box-shadow 0.2s, opacity 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05);
            cursor: pointer;
        }
        .btn-primary-action:hover {
            background-color: #004182;
            box-shadow: 0 2px 4px 0 rgba(0,0,0,0.1);
        }
        .btn-primary-action:disabled {
            background-color: #A0AEC0;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .btn-primary-action i {
            margin-right: 0.5rem;
        }
        .btn-secondary-outline {
            background-color: transparent;
            color: #0A66C2;
            border: 1px solid #0A66C2;
            border-radius: 20px;
            padding: 0.5rem 1.25rem;
            font-weight: 600;
            transition: background-color 0.2s, color 0.2s;
        }
        .btn-secondary-outline:hover {
            background-color: #E0F2FE;
        }
        /* Community Layout */
        .community-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
        @media (min-width: 1024px) {
            .community-layout {
                grid-template-columns: 1fr 320px;
            }
        }
        .card-base {
            background-color: #FFFFFF;
            border-radius: 8px;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.08), 0 2px 3px rgba(0,0,0,0.06);
            padding: 1.25rem;
        }
        /* Create Post Card */
        .create-post-card {
            margin-bottom: 1rem;
        }
        .create-post-input-area {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        .create-post-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: #0A66C2;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }
        .create-post-card textarea {
            width: 100%;
            min-height: 52px;
            border: 1px solid #D1D5DB;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            resize: vertical;
            font-size: 0.95rem;
            line-height: 1.6;
        }
        .create-post-card textarea:focus {
            outline: none;
            border-color: #0A66C2;
            box-shadow: 0 0 0 2px rgba(10, 102, 194, 0.2);
        }
        .image-upload-placeholder {
            border: 2px dashed #D1D5DB;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            color: #6B7280;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .image-upload-placeholder:hover {
            border-color: #0A66C2;
        }
        .post-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 0.5rem;
        }
        .post-action-buttons button, .post-action-buttons a {
            background: none;
            border: none;
            color: #6B7280;
            padding: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: color 0.2s, background-color 0.2s;
            display: inline-flex;
            align-items: center;
            border-radius: 6px;
            text-decoration: none;
        }
        .post-action-buttons button i, .post-action-buttons a i {
            font-size: 1.125rem;
            margin-right: 0.5rem;
            color: #9CA3AF;
        }
        .post-action-buttons button:hover, .post-action-buttons a:hover {
            background-color: #F3F4F6;
            color: #0A66C2;
        }
        .post-action-buttons button:hover i, .post-action-buttons a:hover i {
            color: #0A66C2;
        }
        /* Post Feed Item Card */
        .post-card {
            margin-bottom: 1rem;
        }
        .post-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
            position: relative;
        }
        .post-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #0A66C2;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 0.75rem;
            flex-shrink: 0;
        }
        .post-author-info a {
            font-weight: 600;
            color: #111827;
            text-decoration: none;
            font-size: 0.9rem;
        }
        .post-author-info a:hover {
            text-decoration: underline;
        }
        .post-timestamp {
            font-size: 0.75rem;
            color: #6B7280;
        }
        .post-options-btn {
            margin-left: auto;
            color: #9CA3AF;
            padding: 0.25rem 0.5rem;
            border-radius: 50%;
            cursor: pointer;
        }
        .post-options-btn:hover {
            background-color: #F3F4F6;
        }
        .post-options-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: white;
            border: 1px solid #E5E7EB;
            border-radius: 6px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 10;
            min-width: 120px;
        }
        .post-options-dropdown button {
            display: block;
            width: 100%;
            text-align: left;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            color: #374151;
        }
        .post-options-dropdown button:hover {
            background-color: #F3F4F6;
        }
        .post-content {
            font-size: 0.9rem;
            line-height: 1.6;
            color: #1F2937;
            margin-bottom: 1rem;
            white-space: pre-wrap;
        }
        .post-content p {
            margin-bottom: 0.75rem;
        }
        .post-image {
            max-height: 450px;
            border-radius: 8px;
            margin: 0.75rem 0 1rem 0;
            overflow: hidden;
        }
        .post-image img {
            width: 100%;
            height: auto;
            display: block;
        }
        .post-stats {
            font-size: 0.8rem;
            color: #6B7280;
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid #E5E7EB;
            display: flex;
            gap: 1rem;
        }
        .post-footer {
            display: flex;
            justify-content: space-around;
        }
        .post-footer button {
            background: none;
            border: none;
            color: #4B5563;
            padding: 0.625rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            border-radius: 6px;
            transition: background-color 0.2s, color 0.2s;
            flex-grow: 1;
            justify-content: center;
        }
        .post-footer button i {
            font-size: 1.125rem;
            margin-right: 0.5rem;
        }
        .post-footer button:hover {
            background-color: #EFF6FF;
            color: #0A66C2;
        }
        .post-footer button.liked {
            color: #0A66C2;
            font-weight: 700;
        }
        /* Comment Section Styles */
        .comments-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #E5E7EB;
        }
        .comment {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            position: relative;
        }
        .comment-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #D1D5DB;
            color: #4B5563;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            flex-shrink: 0;
        }
        .comment-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        .comment-content-wrapper {
            background-color: #F3F4F6;
            border-radius: 12px;
            padding: 0.5rem 0.75rem;
            flex-grow: 1;
        }
        .commenter-name {
            font-weight: 600;
            color: #111827;
            margin-right: 0.5rem;
        }
        .comment-text {
            color: #374151;
            line-height: 1.5;
            white-space: pre-wrap;
        }
        .comment-timestamp {
            font-size: 0.7rem;
            color: #9CA3AF;
            margin-left: 0.5rem;
        }
        .comment-options-btn {
            position: absolute;
            top: 0;
            right: 0;
            color: #9CA3AF;
            padding: 0.1rem 0.3rem;
            cursor: pointer;
            border-radius: 50%;
        }
        .comment-options-btn:hover {
            background-color: #E5E7EB;
        }
        .comment-options-dropdown {
            position: absolute;
            top: 1.5rem;
            right: 0;
            background-color: white;
            border: 1px solid #E5E7EB;
            border-radius: 6px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 10;
            min-width: 100px;
        }
        .comment-options-dropdown button {
            display: block;
            width: 100%;
            text-align: left;
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
            color: #374151;
        }
        .comment-options-dropdown button:hover {
            background-color: #F3F4F6;
        }
        .add-comment-area {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .add-comment-area textarea {
            flex-grow: 1;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            resize: none;
            min-height: 40px;
            max-height: 100px;
        }
        .add-comment-area button {
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
        }
        .edit-comment-area textarea {
            width: 100%;
            border: 1px solid #0A66C2;
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
        }
        .edit-comment-area button {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            margin-left: 0.25rem;
        }
        /* Sidebar Styles */
        .community-right-sidebar {
            height: fit-content;
        }
        .sidebar-section-title {
            font-size: 1rem;
            font-weight: 600;
            color: #111827;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #E5E7EB;
        }
        .message-preview, .market-item-preview {
            display: flex;
            align-items: center;
            padding: 0.75rem 0.25rem;
            font-size: 0.875rem;
            color: #4B5563;
            cursor: pointer;
            border-bottom: 1px solid #F3F4F6;
            transition: background-color 0.2s;
        }
        .message-preview:last-child, .market-item-preview:last-child {
            border-bottom: none;
        }
        .message-preview:hover, .market-item-preview:hover {
            background-color: #F9FAFB;
        }
        .message-avatar, .market-item-thumbnail {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: #BFDBFE;
            color: #1E40AF;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            margin-right: 0.75rem;
            flex-shrink: 0;
        }
        .market-item-thumbnail {
            border-radius: 6px;
        }
        .market-item-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }
        .market-item-info p {
            margin: 0;
            line-height: 1.3;
        }
        .view-all-link {
            display: block;
            text-align: center;
            font-size: 0.875rem;
            font-weight: 600;
            color: #0A66C2;
            padding-top: 1rem;
            text-decoration: none;
            transition: color 0.2s;
        }
        .view-all-link:hover {
            color: #004182;
            text-decoration: underline;
        }
        .btn-list-item {
            width: 100%;
            margin-top: 1.25rem;
        }
        #loadMorePostsBtn {
            margin-top: 1.5rem;
        }
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #FFFFFF;
            border-radius: 12px;
            padding: 1.5rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .modal-close {
            background-color: #E2E8F0;
            color: #2D3748;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-weight: 500;
            cursor: pointer;
        }
        .modal-close:hover {
            background-color: #CBD5E0;
        }
        /* Media Queries */
        .mobile-header {
            display: none;
        }
        @media (max-width: 1024px) {
            .community-layout {
                grid-template-columns: 1fr;
            }
            .community-right-sidebar {
                margin-top: 1.5rem;
            }
        }
        @media (max-width: 768px) {
            .sidebar-nova7 {
                transform: translateX(-100%);
                top: 0;
                height: 100vh;
            }
            .sidebar-nova7.open {
                transform: translateX(0);
            }
            .main-content-area {
                margin-left: 0;
                width: 100%;
                padding-top: calc(60px + 1rem);
                padding: 1rem;
            }
            .desktop-header {
                display: none;
            }
            .mobile-header {
                display: flex;
                background-color: #FFFFFF;
                box-shadow: 0 1px 2px rgba(0,0,0,0.05);
                padding: 0 1rem;
                height: 60px;
                align-items: center;
                justify-content: space-between;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                z-index: 50;
            }
            .post-actions {
                flex-direction: column;
                gap: 0.75rem;
                align-items: stretch;
            }
            .post-action-buttons {
                display: flex;
                justify-content: space-around;
                order: 2;
            }
            .post-actions .btn-primary-action {
                width: 100%;
                order: 1;
            }
            .modal-content {
                padding: 1rem;
            }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <header class="mobile-header md:hidden">
        <button id="hamburgerBtnMobile" class="p-2 text-gray-700 hover:text-blue-600">
            <i class="fas fa-bars text-2xl"></i>
        </button>
        <a href="dashboard.html">
            <img src="nova-logo.png" alt="nova7 Logo" class="nova7-logo-header">
        </a>
        <a href="#" id="mobileLogoutLink" class="p-2 text-gray-700 hover:text-blue-600">
            <i class="fas fa-sign-out-alt text-xl"></i>
        </a>
    </header>

    <aside id="sidebar" class="sidebar-nova7">
        <div class="sidebar-header">
            <a href="dashboard.html" class="flex items-center">
                <img src="nova-logo.png" alt="nova7 Logo" class="sidebar-logo-img" 
                     style="filter: brightness(0) invert(1);" onerror="this.style.display='none';">
            </a>
        </div>
        <nav class="flex-grow">
            <a href="dashboard.html" class="nav-link-sidebar">
                <i class="fas fa-tachometer-alt"></i>Dashboard
            </a>
            <a href="view-transactions.html" class="nav-link-sidebar">
                <i class="fas fa-exchange-alt"></i>Transactions
            </a>
            <a href="reports.html" class="nav-link-sidebar">
                <i class="fas fa-chart-pie"></i>Reports
            </a>
            <a href="community.html" class="nav-link-sidebar active">
                <i class="fas fa-users"></i>Community & Lending
            </a>
            <a href="chatbot.html" class="nav-link-sidebar">
                <i class="fas fa-comments-dollar"></i>Chat Advisor
            </a>
            <a href="resources.html" class="nav-link-sidebar">
                <i class="fas fa-book-open"></i>Resources
            </a>
            <a href="settings.html" class="nav-link-sidebar">
                <i class="fas fa-cog"></i>Settings
            </a>
            <a href="wallet.html" class="nav-link-sidebar">
                <i class="fas fa-wallet"></i>Wallet
            </a>
        </nav>
        <div class="pb-4">
            <a href="profile.html" class="nav-link-sidebar">
                <i class="fas fa-user-circle"></i>Profile
            </a>
            <a href="#" id="sidebarLogoutLink" class="nav-link-sidebar">
                <i class="fas fa-sign-out-alt"></i>Logout
            </a>
        </div>
    </aside>

    <main class="main-content-area">
        <header class="desktop-header hidden md:flex items-center justify-between mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Community Hub</h1>
            <div class="flex items-center space-x-3">
                <span id="desktopUserWelcome" class="text-sm text-gray-700">Welcome, User!</span>
            </div>
        </header>
        <h1 class="text-2xl font-bold text-gray-800 mb-6 md:hidden">Community Hub</h1>

        <div class="community-layout">
            <div class="space-y-6">
                <div class="create-post-card card-base">
                    <div class="create-post-input-area">
                        <div class="create-post-avatar" id="userAvatarCreatePost">U</div>
                        <textarea id="postContentInput" placeholder="Start a discussion, share an update..."></textarea>
                    </div>
                    <div class="image-upload-placeholder" id="imageUploadPlaceholder">
                        <i class="fas fa-camera"></i>
                        <p>Click or drag an image here to upload</p>
                        <p class="text-xs mt-1">PNG, JPG, JPEG up to 5MB</p>
                    </div>
                    <input type="file" id="postImageUpload" class="hidden" accept="image/png,image/jpeg,image/jpg">
                    <div id="postImagePreviewContainer" class="mt-2 flex gap-2"></div>
                    <div class="post-actions">
                        <div class="post-action-buttons">
                            <a href="list-lendable-product.html"><button title="List a Lendable Product"><i class="fas fa-box"></i>Lend Product</button></a>
                            <a href="request-money-loan.html"><button title="Request a Loan"><i class="fas fa-hand-holding-usd"></i>Request Loan</button></a>
                        </div>
                        <button id="submitPostBtn" class="btn-primary-action !py-2 !px-5 text-sm">Post</button>
                    </div>
                </div>

                <div id="postFeed" class="space-y-4">
                    <p id="feedLoadingMessage" class="text-center text-gray-500 py-8">Loading posts...</p>
                </div>
                <div class="flex justify-center">
                    <button id="loadMorePostsBtn" class="btn-primary-action hidden">Load More Posts</button>
                </div>
            </div>

            <div class="community-right-sidebar card-base space-y-6">
                <div>
                    <h3 class="sidebar-section-title">Marketplace Highlights</h3>
                    <div class="space-y-3" id="marketplaceHighlights">
                        <p class="text-xs text-gray-500">Loading marketplace items...</p>
                    </div>
                    <a href="marketplace.html" class="view-all-link">Explore Full Marketplace</a>
                    <a href="list-lendable-product.html" class="btn-primary-action btn-list-item text-sm mt-4">
                        <i class="fas fa-box"></i>List a Lendable Product
                    </a>
                </div>
                <hr class="my-4 border-gray-200">
                <div>
                    <h3 class="sidebar-section-title">My Messages</h3>
                    <div class="space-y-3" id="messagesPreview">
                        <p class="text-xs text-gray-500">No new messages.</p>
                    </div>
                    <a href="#" class="view-all-link">View All Messages (Placeholder)</a>
                </div>
            </div>
        </div>

        <div id="editPostModal" class="modal-overlay hidden">
            <div class="modal-content">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Edit Post</h2>
                <form id="editPostForm" class="space-y-4">
                    <div>
                        <label for="editPostContent" class="form-label">Post Content</label>
                        <textarea id="editPostContent" name="content" class="form-input-styled w-full h-32" required></textarea>
                    </div>
                    <div class="flex justify-end space-x-3 mt-4">
                        <button type="button" id="closeEditModalBtn" class="modal-close">Cancel</button>
                        <button type="submit" id="savePostBtn" class="btn-primary-action">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <script>
        let currentUserId = null;
        let currentUserFullName = "User";
        let currentPostPage = 1;
        const postsPerPage = 10;
        let uploadedPostImageUrl = null;
        let editingPostId = null;
        let pageCsrfToken = null; // For storing CSRF token

        document.addEventListener('DOMContentLoaded', async function() { // Made async for CSRF
            const authToken = localStorage.getItem('nova7Token'); // Use distinct name for auth token
            if (!authToken || authToken === "undefined" || authToken === "null") {
                window.location.href = 'login.html';
                return;
            }

            try {
                const user = JSON.parse(localStorage.getItem('nova7User'));
                if (user) {
                    currentUserId = user.id;
                    currentUserFullName = user.fullName || "User";
                    const userAvatarCreatePost = document.getElementById('userAvatarCreatePost');
                    if (userAvatarCreatePost) {
                        const initials = currentUserFullName.split(' ').map(name => name[0]).join('').toUpperCase().substring(0, 2);
                        userAvatarCreatePost.textContent = initials || 'U';
                    }
                }
                const desktopUserWelcomeElement = document.getElementById('desktopUserWelcome');
                if (desktopUserWelcomeElement) {
                    desktopUserWelcomeElement.textContent = `Welcome, ${currentUserFullName}!`;
                }
            } catch (e) {
                console.error("Community: Error parsing user data:", e);
                handleLogout(); // If user data is corrupt, logout
                return;
            }

            // Fetch initial CSRF token for POST/PUT/DELETE operations
            try {
                const csrfResponse = await fetch("http://127.0.0.1:5005/api/csrf-token", {
                    method: "GET",
                    credentials: "include"
                });
                const csrfData = await csrfResponse.json();
                if (csrfResponse.ok && csrfData.status === "success" && csrfData.csrf_token) {
                    pageCsrfToken = csrfData.csrf_token;
                    console.log("Community: CSRF token fetched successfully:", pageCsrfToken);
                } else {
                    throw new Error(csrfData.message || "Failed to fetch initial CSRF token for community page.");
                }
            } catch (error) {
                console.error("Community: CSRF token fetch error on page load:", error);
                // Display an error to the user, perhaps disable POST/PUT/DELETE actions
                const feedLoadingMessage = document.getElementById('feedLoadingMessage');
                if(feedLoadingMessage) feedLoadingMessage.textContent = 'Security initialization failed. Some actions may not work. Please refresh.';
            }

            fetchCommunityPosts();
            fetchMarketplaceHighlights();

            // Image Upload Handling (Corrected API port and added CSRF)
            const imageUploadPlaceholder = document.getElementById('imageUploadPlaceholder');
            const postImageUpload = document.getElementById('postImageUpload');
            const postImagePreviewContainer = document.getElementById('postImagePreviewContainer');

            if (imageUploadPlaceholder && postImageUpload) {
                imageUploadPlaceholder.addEventListener('click', () => postImageUpload.click());
                // ... (drag/drop event listeners remain the same) ...
                imageUploadPlaceholder.addEventListener('dragover', (e) => { e.preventDefault(); imageUploadPlaceholder.classList.add('border-blue-600'); });
                imageUploadPlaceholder.addEventListener('dragleave', () => { imageUploadPlaceholder.classList.remove('border-blue-600'); });
                imageUploadPlaceholder.addEventListener('drop', (e) => {
                    e.preventDefault();
                    imageUploadPlaceholder.classList.remove('border-blue-600');
                    if (e.dataTransfer.files.length > 0) {
                        postImageUpload.files = e.dataTransfer.files;
                        postImageUpload.dispatchEvent(new Event('change'));
                    }
                });


                postImageUpload.addEventListener('change', async function(event) {
                    if (postImagePreviewContainer) postImagePreviewContainer.innerHTML = ''; // Clear previous preview
                    uploadedPostImageUrl = null;

                    const file = event.target.files[0];
                    if (!file) return;

                    if (!['image/png', 'image/jpeg', 'image/jpg'].includes(file.type)) {
                        alert('Please upload a valid image (PNG, JPEG, JPG).');
                        postImageUpload.value = ''; return;
                    }
                    if (file.size > 5 * 1024 * 1024) { // 5MB limit
                        alert('Image size must be less than 5MB.');
                        postImageUpload.value = ''; return;
                    }

                    // Display local preview
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imgContainer = document.createElement('div');
                        imgContainer.classList.add('relative', 'inline-block');
                        const imgElement = document.createElement('img');
                        imgElement.src = e.target.result;
                        imgElement.classList.add('h-20', 'w-auto', 'object-contain', 'rounded-md', 'border', 'border-gray-300');
                        const removeBtn = document.createElement('button');
                        removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                        removeBtn.classList.add('absolute', '-top-2', '-right-2', 'bg-red-500', 'text-white', 'rounded-full', 'h-5', 'w-5', 'flex', 'items-center', 'justify-center', 'text-xs');
                        removeBtn.onclick = () => { // Changed to onclick for simplicity here
                            imgContainer.remove();
                            postImageUpload.value = '';
                            uploadedPostImageUrl = null;
                        };
                        imgContainer.appendChild(imgElement);
                        imgContainer.appendChild(removeBtn);
                        if (postImagePreviewContainer) postImagePreviewContainer.appendChild(imgContainer);
                    };
                    reader.readAsDataURL(file);

                    // Upload to server
                    const formData = new FormData();
                    formData.append('file', file);
                    const currentAuthToken = localStorage.getItem('nova7Token'); // Use authToken

                    if (!currentAuthToken || !pageCsrfToken) {
                        alert("Authentication or security token missing. Please refresh.");
                        if (postImagePreviewContainer) postImagePreviewContainer.innerHTML = '';
                        postImageUpload.value = '';
                        return;
                    }

                    try {
                        // --- MODIFICATION: Corrected port and added CSRF for image upload ---
                        const response = await fetch('http://127.0.0.1:5005/api/upload/image?context=community_posts', {
                            method: 'POST',
                            headers: { 
                                'Authorization': `Bearer ${currentAuthToken}`,
                                'X-CSRF-Token': pageCsrfToken
                                // Content-Type is set automatically by browser for FormData
                            },
                            credentials: "include",
                            body: formData
                        });
                        const data = await response.json();
                        if (response.ok && data.status === 'success') {
                            uploadedPostImageUrl = data.imageUrl;
                            console.log("Community: Image uploaded successfully:", uploadedPostImageUrl);
                        } else {
                            alert(`Image upload failed: ${data.message || 'Server error'}`);
                            if (postImagePreviewContainer) postImagePreviewContainer.innerHTML = '';
                            postImageUpload.value = '';
                        }
                    } catch (error) {
                        console.error('Community: Image upload error:', error);
                        alert('Failed to upload image. Please try again.');
                        if (postImagePreviewContainer) postImagePreviewContainer.innerHTML = '';
                        postImageUpload.value = '';
                    }
                });
            }
        });

        function handleLogout() {
            localStorage.removeItem('nova7Token');
            localStorage.removeItem('nova7User');
            localStorage.removeItem('nova7ChatHistory'); 
            localStorage.removeItem('nova7CurrentChatId');
            window.location.href = 'login.html';
        }

        const sidebarLogoutLink = document.getElementById('sidebarLogoutLink');
        if (sidebarLogoutLink) sidebarLogoutLink.addEventListener('click', (e) => { e.preventDefault(); handleLogout(); });
        const mobileLogoutLink = document.getElementById('mobileLogoutLink');
        if (mobileLogoutLink) mobileLogoutLink.addEventListener('click', (e) => { e.preventDefault(); handleLogout(); });
        const hamburgerBtnMobile = document.getElementById('hamburgerBtnMobile');
        const sidebar = document.getElementById('sidebar');
        if (hamburgerBtnMobile && sidebar) {
            hamburgerBtnMobile.addEventListener('click', (e) => { e.stopPropagation(); sidebar.classList.toggle('open'); });
        }
        document.addEventListener('click', (e) => {
            if (sidebar && sidebar.classList.contains('open') && !sidebar.contains(e.target) && (!hamburgerBtnMobile || !hamburgerBtnMobile.contains(e.target))) {
                sidebar.classList.remove('open');
            }
        });

        const submitPostBtn = document.getElementById('submitPostBtn');
        const postContentInput = document.getElementById('postContentInput');
        const postFeed = document.getElementById('postFeed');
        const feedLoadingMessage = document.getElementById('feedLoadingMessage');
        const loadMorePostsBtn = document.getElementById('loadMorePostsBtn');
        const editPostModal = document.getElementById('editPostModal');
        const editPostForm = document.getElementById('editPostForm');
        const closeEditModalBtn = document.getElementById('closeEditModalBtn');

        async function createPost() {
            const content = postContentInput.value.trim();
            if (!content && !uploadedPostImageUrl) {
                alert("Please write something or upload an image to post.");
                return;
            }
            const authToken = localStorage.getItem('nova7Token');
            if (!authToken || !pageCsrfToken) { handleLogout(); return; } // Added CSRF check

            submitPostBtn.disabled = true;
            submitPostBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Posting...';
            const postData = { content, imageUrl: uploadedPostImageUrl };

            try {
                // --- MODIFICATION: Corrected port and added CSRF ---
                const response = await fetch('http://127.0.0.1:5005/api/community/posts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`,
                        'X-CSRF-Token': pageCsrfToken
                    },
                    credentials: "include",
                    body: JSON.stringify(postData)
                });
                const responseData = await response.json();
                if (response.ok && responseData.status === 'success') {
                    postContentInput.value = "";
                    document.getElementById('postImagePreviewContainer').innerHTML = '';
                    uploadedPostImageUrl = null;
                    document.getElementById('postImageUpload').value = "";
                    currentPostPage = 1; // Reset to first page to show new post
                    fetchCommunityPosts(currentPostPage, false); // Fetch and clear existing
                } else {
                    alert(`Error creating post: ${responseData.message || 'Unknown error'}`);
                    if (response.status === 401 || response.status === 422) handleLogout();
                }
            } catch (error) {
                console.error("Error creating post:", error);
                alert("Failed to create post. Please check your connection.");
            } finally {
                submitPostBtn.disabled = false;
                submitPostBtn.innerHTML = 'Post';
            }
        }
        if (submitPostBtn) submitPostBtn.addEventListener('click', createPost);

        async function fetchCommunityPosts(page = 1, append = false) {
            const authToken = localStorage.getItem('nova7Token');
            if (!authToken) { handleLogout(); return; }

            if (feedLoadingMessage && !append) feedLoadingMessage.style.display = 'block';
            if (!append && postFeed) postFeed.innerHTML = '';

            // --- MODIFICATION: Corrected port ---
            const apiUrl = `http://127.0.0.1:5005/api/community/posts?page=${page}&per_page=${postsPerPage}`;
            console.log("Community: Fetching posts from", apiUrl, "with token:", authToken);

            try {
                const response = await fetch(apiUrl, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                if (feedLoadingMessage) feedLoadingMessage.style.display = 'none';

                if (response.ok && data.status === 'success') {
                    if (data.posts.length === 0 && !append) {
                        if(postFeed) postFeed.innerHTML = '<p class="text-center text-gray-500 py-8">No posts yet. Be the first to share!</p>';
                        if(loadMorePostsBtn) loadMorePostsBtn.classList.add('hidden');
                    } else {
                        renderPosts(data.posts, !append); // Pass clearFeed based on append
                        if (loadMorePostsBtn) {
                            if (data.has_next) {
                                loadMorePostsBtn.classList.remove('hidden');
                                loadMorePostsBtn.onclick = () => fetchCommunityPosts(data.current_page + 1, true);
                            } else {
                                loadMorePostsBtn.classList.add('hidden');
                            }
                        }
                    }
                    currentPostPage = data.current_page;
                } else {
                    if(postFeed) postFeed.innerHTML = `<p class="text-center text-red-500 py-8">Error: ${data.message || 'Could not load posts.'}</p>`;
                    if (response.status === 401 || response.status === 422) {
                        console.log("Community (fetch posts): Received 401/422, logging out.");
                        handleLogout();
                    }
                }
            } catch (error) {
                console.error("Error fetching posts:", error);
                if (feedLoadingMessage) feedLoadingMessage.style.display = 'none';
                if(postFeed) postFeed.innerHTML = '<p class="text-center text-red-500 py-8">Failed to connect to server to load posts.</p>';
            }
        }

        function renderPosts(posts, clearFeed = true) {
            if (clearFeed && postFeed) postFeed.innerHTML = '';
            if (!postFeed) return;

            posts.forEach(post => {
                // ... (rest of renderPosts logic remains the same, ensure post.user_id is compared to currentUserId for options) ...
                const postCard = document.createElement('div');
                postCard.classList.add('post-card', 'card-base');
                postCard.setAttribute('id', `post-${post.id}`);
                const postDate = new Date(post.created_at);
                const timeAgo = timeDifference(new Date(), postDate);
                const authorInitials = post.author_avatar_url ? '' : (post.author_name ? post.author_name.split(' ').map(name => name[0]).join('').toUpperCase().substring(0, 2) : '??');

                let imageHtml = '';
                if (post.image_url) {
                    imageHtml = `<div class="post-image"><img src="${post.image_url}" alt="Post image"></div>`;
                }

                let optionsDropdownHtml = '';
                // Ensure currentUserId is a number if post.user_id is a number for comparison
                if (post.user_id === Number(currentUserId)) { 
                    optionsDropdownHtml = `
                        <div class="post-options-btn" data-post-id="${post.id}">
                            <i class="fas fa-ellipsis-h"></i>
                        </div>
                        <div class="post-options-dropdown hidden" id="options-dropdown-${post.id}">
                            <button class="edit-post-btn" data-post-id="${post.id}" data-content="${encodeURIComponent(post.content)}" data-image="${post.image_url || ''}"><i class="fas fa-edit mr-2"></i>Edit</button>
                            <button class="delete-post-btn" data-post-id="${post.id}"><i class="fas fa-trash-alt mr-2"></i>Delete</button>
                        </div>
                    `;
                }

                postCard.innerHTML = `
                    <div class="post-header">
                        <div class="post-avatar" style="${!post.author_avatar_url ? 'background-color: #' + Math.floor(Math.random()*16777215).toString(16) + ';' : ''}">
                            ${post.author_avatar_url ? `<img src="<span class="math-inline">\{post\.author\_avatar\_url\}" alt\="</span>{post.author_name}" class="w-full h-full rounded-full object-cover">` : authorInitials}
                        </div>
                        <div class="post-author-info">
                            <a href="#">${post.author_name}</a>
                            <span class="post-timestamp"><i class="far fa-clock mr-1"></i>${timeAgo}</span>
                        </div>
                        ${optionsDropdownHtml}
                    </div>
                    <div class="post-content" id="post-content-${post.id}">
                        <p>${post.content.replace(/\n/g, '<br>')}</p>
                        ${imageHtml}
                    </div>
                    <div class="post-stats">
                        <span id="likesCount-${post.id}"><i class="fas fa-thumbs-up text-blue-500"></i> ${post.likes_count}</span>
                        <span id="commentsCount-${post.id}"><i class="fas fa-comment text-gray-500"></i> ${post.comments_count}</span>
                    </div>
                    <div class="post-footer">
                        <button class="like-btn ${post.is_liked_by_current_user ? 'liked' : ''}" data-post-id="${post.id}">
                            <i class="far fa-thumbs-up"></i> Like
                        </button>
                        <button class="comment-btn" data-post-id="${post.id}"><i class="far fa-comment-dots"></i> Comment</button>
                        <button class="share-btn" data-post-id="${post.id}"><i class="fas fa-share-alt"></i> Share</button>
                    </div>
                    <div class="comments-section hidden" id="comments-section-${post.id}">
                        <div class="add-comment-area mt-3">
                            <textarea class="add-comment-input" data-post-id="${post.id}" placeholder="Write a comment..."></textarea>
                            <button class="add-comment-submit btn-primary-action !py-1.5 !px-3 text-xs" data-post-id="${post.id}">Reply</button>
                        </div>
                        <div class="comments-list mt-3" id="comments-list-${post.id}"></div>
                    </div>
                `;
                postFeed.appendChild(postCard);
            });
            addPostActionListeners();
        }
        
        // --- (addPostActionListeners and other handlers: ensure API calls use port 5005 and add CSRF for state-changing ones) ---
        function addPostActionListeners() {
            document.querySelectorAll('.like-btn').forEach(button => { button.removeEventListener('click', handleLikeToggle); button.addEventListener('click', handleLikeToggle); });
            document.querySelectorAll('.comment-btn').forEach(button => { button.removeEventListener('click', toggleCommentsSection); button.addEventListener('click', toggleCommentsSection); });
            document.querySelectorAll('.add-comment-submit').forEach(button => { button.removeEventListener('click', handleAddComment); button.addEventListener('click', handleAddComment); });
            document.querySelectorAll('.post-options-btn').forEach(button => { button.removeEventListener('click', togglePostOptionsDropdown); button.addEventListener('click', togglePostOptionsDropdown);});
            document.querySelectorAll('.edit-post-btn').forEach(button => { button.removeEventListener('click', handleEditPost); button.addEventListener('click', handleEditPost);});
            document.querySelectorAll('.delete-post-btn').forEach(button => { button.removeEventListener('click', handleDeletePost); button.addEventListener('click', handleDeletePost); });
            document.querySelectorAll('.share-btn').forEach(button => { button.removeEventListener('click', handleSharePost); button.addEventListener('click', handleSharePost);});
        }

        function togglePostOptionsDropdown(event) { /* ... (same) ... */ 
            const postId = event.currentTarget.dataset.postId;
            const dropdown = document.getElementById(`options-dropdown-${postId}`);
            if (dropdown) dropdown.classList.toggle('hidden');
        }
        function handleSharePost(event) { /* ... (same) ... */
            const postId = event.currentTarget.dataset.postId;
            const postUrl = `${window.location.origin}${window.location.pathname}?postId=${postId}`; // More robust URL
            navigator.clipboard.writeText(postUrl).then(() => {
                alert("Post link copied to clipboard!");
            }).catch(err => {
                alert("Could not copy link. Please copy the URL manually.");
                console.error('Could not copy text:', err);
            });
        }

        async function handleEditPost(event) { /* ... (same, but ensure API call inside uses 5005 and CSRF) ... */ 
            editingPostId = event.currentTarget.dataset.postId;
            const currentContent = decodeURIComponent(event.currentTarget.dataset.content); // Content for text area
            const editPostContentEl = document.getElementById('editPostContent');
            if (editPostContentEl) editPostContentEl.value = currentContent;
            if (editPostModal) editPostModal.classList.remove('hidden');
            const dropdown = document.getElementById(`options-dropdown-${editingPostId}`);
            if (dropdown) dropdown.classList.add('hidden');
        }

        if (editPostForm) {
            editPostForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                const newContent = document.getElementById('editPostContent').value.trim();
                if (!newContent || !editingPostId) return;
                const authToken = localStorage.getItem('nova7Token');
                if (!authToken || !pageCsrfToken) { handleLogout(); return; }

                const savePostBtn = document.getElementById('savePostBtn'); // Get button inside form
                savePostBtn.disabled = true; savePostBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
                try {
                    // --- MODIFICATION: Corrected port and added CSRF ---
                    const response = await fetch(`http://127.0.0.1:5005/api/community/posts/${editingPostId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`,
                            'X-CSRF-Token': pageCsrfToken
                        },
                        credentials: "include",
                        body: JSON.stringify({ content: newContent })
                    });
                    const data = await response.json();
                    if (response.ok && data.status === 'success') {
                        const postContentDivP = document.querySelector(`#post-content-${editingPostId} p`);
                        if (postContentDivP) postContentDivP.innerHTML = newContent.replace(/\n/g, '<br>');
                        const editButtonInDropdown = document.querySelector(`.edit-post-btn[data-post-id="${editingPostId}"]`);
                        if (editButtonInDropdown) editButtonInDropdown.dataset.content = encodeURIComponent(newContent);
                        if (editPostModal) editPostModal.classList.add('hidden');
                    } else {
                        alert(`Error updating post: ${data.message || 'Unknown error'}`);
                        if (response.status === 401 || response.status === 422) handleLogout();
                    }
                } catch (error) {
                    console.error("Error editing post:", error); alert("Failed to edit post.");
                } finally {
                    savePostBtn.disabled = false; savePostBtn.innerHTML = 'Save Changes'; editingPostId = null;
                }
            });
        }
        if (closeEditModalBtn) closeEditModalBtn.addEventListener('click', () => { if(editPostModal) editPostModal.classList.add('hidden'); editingPostId = null; });

        async function handleDeletePost(event) { /* ... (ensure API call uses 5005 and CSRF) ... */
            const postId = event.currentTarget.dataset.postId;
            if (!confirm("Are you sure you want to delete this post? This action cannot be undone.")) return;
            const authToken = localStorage.getItem('nova7Token');
            if (!authToken || !pageCsrfToken) { handleLogout(); return; }
            try {
                 // --- MODIFICATION: Corrected port and added CSRF ---
                const response = await fetch(`http://127.0.0.1:5005/api/community/posts/${postId}`, {
                    method: 'DELETE',
                    headers: { 
                        'Authorization': `Bearer ${authToken}`,
                        'X-CSRF-Token': pageCsrfToken
                    },
                    credentials: "include"
                });
                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    const postElement = document.getElementById(`post-${postId}`);
                    if(postElement) postElement.remove();
                } else {
                    alert(`Error deleting post: ${data.message || 'Unknown error'}`);
                    if (response.status === 401 || response.status === 422) handleLogout();
                }
            } catch (error) {
                console.error("Error deleting post:", error); alert("Failed to delete post.");
            }
        }

        async function handleLikeToggle(event) { /* ... (ensure API call uses 5005 and CSRF for POST) ... */
            const button = event.currentTarget;
            const postId = button.dataset.postId;
            const authToken = localStorage.getItem('nova7Token');
            if (!authToken || !pageCsrfToken) { handleLogout(); return; }
            try {
                 // --- MODIFICATION: Corrected port and added CSRF ---
                const response = await fetch(`http://127.0.0.1:5005/api/community/posts/${postId}/like`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${authToken}`,
                        'X-CSRF-Token': pageCsrfToken,
                        'Content-Type': 'application/json' // Good practice for POST
                    },
                    credentials: "include"
                });
                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    const likesCountEl = document.getElementById(`likesCount-${postId}`);
                    if (likesCountEl) likesCountEl.innerHTML = `<i class="fas fa-thumbs-up text-blue-500"></i> ${data.likes_count}`;
                    button.classList.toggle('liked', data.is_liked_by_current_user);
                } else {
                    alert(data.message || "Failed to update like.");
                    if (response.status === 401 || response.status === 422) handleLogout();
                }
            } catch (error) {
                console.error("Error toggling like:", error); alert("Could not update like status.");
            }
        }

        async function toggleCommentsSection(event) { /* ... (ensure API call uses 5005) ... */
            const postId = event.currentTarget.dataset.postId;
            const commentsSection = document.getElementById(`comments-section-${postId}`);
            const commentsListDiv = document.getElementById(`comments-list-${postId}`);
            if (!commentsSection || !commentsListDiv) return;

            if (commentsSection.classList.contains('hidden')) {
                commentsSection.classList.remove('hidden');
                commentsListDiv.innerHTML = '<p class="text-xs text-gray-500">Loading comments...</p>';
                const authToken = localStorage.getItem('nova7Token');
                if (!authToken) { handleLogout(); return; }
                try {
                    // --- MODIFICATION: Corrected port ---
                    const response = await fetch(`http://127.0.0.1:5005/api/community/posts/${postId}/comments`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    const data = await response.json();
                    commentsListDiv.innerHTML = '';
                    if (response.ok && data.status === 'success') {
                        if (data.comments.length > 0) {
                            data.comments.forEach(comment => renderComment(comment, commentsListDiv));
                        } else {
                            commentsListDiv.innerHTML = '<p class="text-xs text-gray-500">No comments yet. Be the first!</p>';
                        }
                    } else {
                        commentsListDiv.innerHTML = `<p class="text-xs text-red-500">Error: ${data.message || 'Could not load comments.'}</p>`;
                        if (response.status === 401 || response.status === 422) handleLogout();
                    }
                } catch (error) {
                    console.error("Error fetching comments:", error);
                    commentsListDiv.innerHTML = '<p class="text-xs text-red-500">Failed to load comments.</p>';
                }
            } else {
                commentsSection.classList.add('hidden');
            }
        }

        function renderComment(comment, commentsListDiv) { /* ... (same, ensure delete/edit inside use CSRF and correct port) ... */
            const commentDiv = document.createElement('div');
            commentDiv.classList.add('comment');
            commentDiv.setAttribute('id', `comment-${comment.id}`);
            const commenterInitials = comment.commenter_avatar_url ? '' : (comment.commenter_name ? comment.commenter_name.split(' ').map(name => name[0]).join('').toUpperCase().substring(0, 2) : '??');
            let commentOptionsHtml = '';
            if (comment.user_id === Number(currentUserId)) {
                commentOptionsHtml = `
                    <div class="comment-options-btn" data-comment-id="${comment.id}"> <i class="fas fa-ellipsis-v fa-xs"></i> </div>
                    <div class="comment-options-dropdown hidden" id="comment-options-dropdown-${comment.id}">
                        <button class="edit-comment-btn" data-comment-id="${comment.id}" data-content="${encodeURIComponent(comment.content)}"><i class="fas fa-edit mr-1"></i>Edit</button>
                        <button class="delete-comment-btn" data-comment-id="${comment.id}"><i class="fas fa-trash-alt mr-1"></i>Delete</button>
                    </div>`;
            }
            commentDiv.innerHTML = `
                <div class="comment-avatar" style="${!comment.commenter_avatar_url ? 'background-color: #' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0') + ';' : ''}">
                    ${comment.commenter_avatar_url ? `<img src="<span class="math-inline">\{comment\.commenter\_avatar\_url\}" alt\="</span>{comment.commenter_name}">` : commenterInitials}
                </div>
                <div class="comment-content-wrapper">
                    <div>
                        <span class="commenter-name">${comment.commenter_name}</span>
                        <span class="comment-timestamp">${timeDifference(new Date(), new Date(comment.created_at))}</span>
                        ${comment.created_at !== comment.updated_at ? `<span class="comment-timestamp text-gray-400 italic">(edited)</span>` : ''}
                    </div>
                    <p class="comment-text" id="comment-text-${comment.id}">${comment.content.replace(/\n/g, '<br>')}</p>
                    <div class="edit-comment-area hidden mt-1" id="edit-comment-area-${comment.id}">
                        <textarea class="edit-comment-input w-full text-xs p-1 border rounded"></textarea>
                        <button class="save-edit-comment-btn btn-primary-action !py-0.5 !px-2 text-xs" data-comment-id="${comment.id}">Save</button>
                        <button class="cancel-edit-comment-btn btn-secondary-action !py-0.5 !px-2 text-xs" data-comment-id="${comment.id}">Cancel</button>
                    </div>
                </div>
                ${commentOptionsHtml}`;
            commentsListDiv.appendChild(commentDiv);
            if (comment.user_id === Number(currentUserId)) {
                commentDiv.querySelector('.comment-options-btn')?.addEventListener('click', toggleCommentOptionsDropdown);
                commentDiv.querySelector('.edit-comment-btn')?.addEventListener('click', handleEditComment);
                commentDiv.querySelector('.delete-comment-btn')?.addEventListener('click', handleDeleteComment);
            }
        }


        function toggleCommentOptionsDropdown(event) { /* ... (same) ... */
            const commentId = event.currentTarget.dataset.commentId;
            const dropdown = document.getElementById(`comment-options-dropdown-${commentId}`);
            if (dropdown) dropdown.classList.toggle('hidden');
        }

        async function handleEditComment(event) { /* ... (ensure API call uses 5005 and CSRF for PUT) ... */
            const commentId = event.currentTarget.dataset.commentId;
            const currentContent = decodeURIComponent(event.currentTarget.dataset.content);
            const commentTextP = document.getElementById(`comment-text-${commentId}`);
            const editArea = document.getElementById(`edit-comment-area-${commentId}`);
            const editInput = editArea.querySelector('.edit-comment-input');

            commentTextP.classList.add('hidden');
            editInput.value = currentContent;
            editArea.classList.remove('hidden');
            document.getElementById(`comment-options-dropdown-${commentId}`).classList.add('hidden');

            editArea.querySelector('.save-edit-comment-btn').onclick = async () => {
                const newContent = editInput.value.trim();
                if (!newContent || newContent === currentContent) { 
                    commentTextP.classList.remove('hidden'); editArea.classList.add('hidden'); return; 
                }
                const authToken = localStorage.getItem('nova7Token');
                if (!authToken || !pageCsrfToken) { handleLogout(); return; }
                try {
                    // --- MODIFICATION: Corrected port and added CSRF ---
                    const response = await fetch(`http://127.0.0.1:5005/api/community/comments/${commentId}`, {
                        method: 'PUT',
                        headers: { 
                            'Content-Type': 'application/json', 
                            'Authorization': `Bearer ${authToken}`,
                            'X-CSRF-Token': pageCsrfToken 
                        },
                        credentials: "include",
                        body: JSON.stringify({ content: newContent })
                    });
                    const data = await response.json();
                    if (response.ok && data.status === 'success') {
                        commentTextP.innerHTML = newContent.replace(/\n/g, '<br>');
                        const editButtonInDropdown = document.querySelector(`.edit-comment-btn[data-comment-id="${commentId}"]`);
                        if (editButtonInDropdown) editButtonInDropdown.dataset.content = encodeURIComponent(newContent);
                    } else {
                        alert(`Error: ${data.message || 'Could not update comment.'}`);
                        if (response.status === 401 || response.status === 422) handleLogout();
                    }
                } catch (err) { alert("Failed to update comment."); console.error(err); }
                commentTextP.classList.remove('hidden'); editArea.classList.add('hidden');
            };
            editArea.querySelector('.cancel-edit-comment-btn').onclick = () => {
                commentTextP.classList.remove('hidden'); editArea.classList.add('hidden');
            };
        }

        async function handleDeleteComment(event) { /* ... (ensure API call uses 5005 and CSRF for DELETE) ... */
            const commentId = event.currentTarget.dataset.commentId;
            if (!confirm("Are you sure you want to delete this comment?")) return;
            const authToken = localStorage.getItem('nova7Token');
            if (!authToken || !pageCsrfToken) { handleLogout(); return; }
            try {
                // --- MODIFICATION: Corrected port and added CSRF ---
                const response = await fetch(`http://127.0.0.1:5005/api/community/comments/${commentId}`, {
                    method: 'DELETE',
                    headers: { 
                        'Authorization': `Bearer ${authToken}`,
                        'X-CSRF-Token': pageCsrfToken
                    },
                    credentials: "include"
                });
                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    const commentElement = document.getElementById(`comment-${commentId}`);
                    const postCard = commentElement?.closest('.post-card'); // Optional chaining
                    if (commentElement) commentElement.remove();
                    if (postCard) {
                        const postId = postCard.id.split('-')[1];
                        const commentsCountEl = document.getElementById(`commentsCount-${postId}`);
                        if (commentsCountEl) {
                            const currentCountMatch = commentsCountEl.textContent.match(/\d+/);
                            const currentCount = currentCountMatch ? parseInt(currentCountMatch[0]) : 0;
                            commentsCountEl.innerHTML = `<i class="fas fa-comment text-gray-500"></i> ${Math.max(0, currentCount - 1)}`;
                        }
                    }
                } else {
                    alert(`Error: ${data.message || 'Could not delete comment.'}`);
                    if (response.status === 401 || response.status === 422) handleLogout();
                }
            } catch (err) { alert("Failed to delete comment."); console.error(err); }
        }


        async function handleAddComment(event) { /* ... (ensure API call uses 5005 and CSRF for POST) ... */
            const button = event.currentTarget;
            const postId = button.dataset.postId;
            const commentTextarea = document.querySelector(`.add-comment-input[data-post-id="${postId}"]`);
            const content = commentTextarea.value.trim();
            if (!content) { alert("Comment cannot be empty."); return; }
            const authToken = localStorage.getItem('nova7Token');
            if (!authToken || !pageCsrfToken) { handleLogout(); return; }

            button.disabled = true; button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            try {
                // --- MODIFICATION: Corrected port and added CSRF ---
                const response = await fetch(`http://127.0.0.1:5005/api/community/posts/${postId}/comments`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Authorization': `Bearer ${authToken}`,
                        'X-CSRF-Token': pageCsrfToken
                    },
                    credentials: "include",
                    body: JSON.stringify({ content })
                });
                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    commentTextarea.value = '';
                    const commentsListDiv = document.getElementById(`comments-list-${postId}`);
                    if (commentsListDiv.querySelector('.text-xs.text-gray-500')) { commentsListDiv.innerHTML = ''; } // Clear "no comments" message
                    renderComment(data.comment, commentsListDiv); // data.comment should be the new comment object
                    const commentsCountEl = document.getElementById(`commentsCount-${postId}`);
                    if (commentsCountEl) {
                         const currentCountMatch = commentsCountEl.textContent.match(/\d+/);
                         const currentCount = currentCountMatch ? parseInt(currentCountMatch[0]) : 0;
                         commentsCountEl.innerHTML = `<i class="fas fa-comment text-gray-500"></i> ${currentCount + 1}`;
                    }
                } else {
                    alert(`Error adding comment: ${data.message || 'Unknown error'}`);
                    if (response.status === 401 || response.status === 422) handleLogout();
                }
            } catch (error) {
                console.error("Error adding comment:", error); alert("Failed to add comment.");
            } finally {
                button.disabled = false; button.textContent = 'Reply';
            }
        }

        async function fetchMarketplaceHighlights() { /* ... (ensure API call uses 5005) ... */
            const marketplaceHighlightsDiv = document.getElementById('marketplaceHighlights');
            if (!marketplaceHighlightsDiv) return;
            marketplaceHighlightsDiv.innerHTML = '<p class="text-xs text-gray-500">Loading highlights...</p>';
            try {
                // --- MODIFICATION: Corrected port ---
                const response = await fetch(`http://127.0.0.1:5005/api/marketplace/items?page=1&per_page=3&sort=newest`);
                const data = await response.json();
                marketplaceHighlightsDiv.innerHTML = '';
                if (response.ok && data.status === 'success' && data.items.length > 0) {
                    data.items.forEach(item => { /* ... (same rendering) ... */ 
                        const itemDiv = document.createElement('div');
                        itemDiv.classList.add('market-item-preview');
                        let itemImageHTML = `<div class="market-item-thumbnail"><i class="fas fa-store text-lg"></i></div>`;
                        if (item.image_urls && item.image_urls.length > 0) {
                            itemImageHTML = `<div class="market-item-thumbnail"><img src="${item.image_urls[0]}" alt="${item.title}"></div>`;
                        }
                        itemDiv.innerHTML = `
                            ${itemImageHTML}
                            <div class="market-item-info">
                                <a href="marketplace-item-detail.html?itemId=${item.id}" class="font-semibold text-sm text-gray-800 hover:underline">${item.title}</a>
                                <p class="text-xs text-green-600 font-bold">$${parseFloat(item.price).toFixed(2)}</p>
                            </div>
                        `;
                        marketplaceHighlightsDiv.appendChild(itemDiv);
                    });
                } else {
                    marketplaceHighlightsDiv.innerHTML = '<p class="text-xs text-gray-500">No items to display currently.</p>';
                }
            } catch (error) {
                console.error("Error fetching marketplace highlights:", error);
                marketplaceHighlightsDiv.innerHTML = '<p class="text-xs text-red-500">Could not load highlights.</p>';
            }
        }

        function timeDifference(current, previous) { /* ... (same) ... */
            const msPerMinute = 60 * 1000; const msPerHour = msPerMinute * 60; const msPerDay = msPerHour * 24;
            const elapsed = current - previous;
            if (elapsed < msPerMinute) return Math.round(elapsed / 1000) + 's ago';
            else if (elapsed < msPerHour) return Math.round(elapsed / msPerMinute) + 'm ago';
            else if (elapsed < msPerDay) return Math.round(elapsed / msPerHour) + 'h ago';
            else { const days = Math.round(elapsed / msPerDay);
                if (days < 7) return days + 'd ago';
                else return previous.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
        }
        console.log("Community Hub page loaded and scripts attached.");
    </script>
</body>
</html>