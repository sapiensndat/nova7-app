<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin KYC Validation - nova7</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F3F2EF;
            color: #1a202c;
        }
        .sidebar-nova7 {
            background-color: #004182;
            color: #E0F2FE;
            width: 260px;
            box-shadow: 2px 0 8px rgba(0,0,0,0.15);
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            padding-top: 1.5rem;
            transition: transform 0.3s ease-in-out;
            z-index: 40;
            display: flex;
            flex-direction: column;
        }
        .sidebar-header {
            padding: 0 1.5rem 1.5rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid #0053a0;
            margin-bottom: 1rem;
        }
        .sidebar-logo-img {
            max-height: 120px;
            width: auto;
        }
        .nova7-logo-header {
            max-height: 36px;
            width: auto;
        }
        .sidebar-nova7 .nav-link-sidebar {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            margin: 0.25rem 1rem;
            font-weight: 500;
            color: #E0F2FE;
            transition: background-color 0.2s, color 0.2s;
        }
        .sidebar-nova7 .nav-link-sidebar:hover {
            background-color: #0A66C2;
            color: #FFFFFF;
        }
        .sidebar-nova7 .nav-link-sidebar.active {
            background-color: #FFFFFF;
            color: #0A66C2;
            font-weight: 600;
        }
        .sidebar-nova7 .nav-link-sidebar i {
            width: 20px;
            margin-right: 0.75rem;
            text-align: center;
        }
        .main-content-area {
            margin-left: 260px;
            padding: 2rem;
            width: calc(100% - 260px);
            min-height: 100vh;
        }
        .card-linkedin {
            background-color: #FFFFFF;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 2rem;
        }
        .btn-primary-linkedin {
            background-color: #0A66C2;
            color: white;
            border-radius: 6px;
            padding: 8px 16px;
            font-weight: 600;
            transition: background-color 0.2s;
            border: none;
            cursor: pointer;
        }
        .btn-primary-linkedin:hover {
            background-color: #004182;
        }
        .btn-secondary {
            background-color: #6B7280;
            color: white;
            border-radius: 6px;
            padding: 8px 16px;
            font-weight: 600;
            transition: background-color 0.2s;
            border: none;
            cursor: pointer;
        }
        .btn-secondary:hover {
            background-color: #4B5563;
        }
        .btn-danger {
            background-color: #EF4444;
            color: white;
            border-radius: 6px;
            padding: 8px 16px;
            font-weight: 600;
            transition: background-color 0.2s;
            border: none;
            cursor: pointer;
        }
        .btn-danger:hover {
            background-color: #DC2626;
        }
        .message-success {
            color: #10B981;
        }
        .message-error {
            color: #EF4444;
        }
        .mobile-header { display: none; }
        @media (max-width: 768px) {
            .sidebar-nova7 { transform: translateX(-100%); top: 0; height: 100vh; }
            .sidebar-nova7.open { transform: translateX(0); }
            .main-content-area { margin-left: 0; width: 100%; padding-top: calc(60px + 1rem); padding: 1rem; }
            .desktop-header { display: none; }
            .mobile-header {
                display: flex;
                background-color: #FFFFFF;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                padding: 0 1rem;
                height: 60px;
                align-items: center;
                justify-content: space-between;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                z-index: 50;
            }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <header class="mobile-header md:hidden">
        <button id="hamburgerBtnMobile" class="p-2 text-gray-700 hover:text-blue-600">
            <i class="fas fa-bars text-2xl"></i>
        </button>
        <a href="dashboard.html">
            <img src="nova-logo.png" alt="nova7 Logo" class="nova7-logo-header">
        </a>
        <a href="#" id="mobileLogoutLink" class="p-2 text-gray-700 hover:text-blue-600">
            <i class="fas fa-sign-out-alt text-xl"></i>
        </a>
    </header>
    <aside id="sidebar" class="sidebar-nova7">
        <div class="sidebar-header">
            <a href="dashboard.html" class="flex items-center">
                <img src="nova-logo.png" alt="nova7 Logo" class="sidebar-logo-img"
                     style="filter: brightness(0) invert(1);"
                     onerror="this.style.display='none';">
            </a>
        </div>
        <nav class="flex-grow">
            <a href="dashboard.html" class="nav-link-sidebar">
                <i class="fas fa-tachometer-alt"></i>Dashboard
            </a>
            <a href="view-transactions.html" class="nav-link-sidebar">
                <i class="fas fa-exchange-alt"></i>Transactions
            </a>
            <a href="reports.html" class="nav-link-sidebar">
                <i class="fas fa-chart-pie"></i>Reports
            </a>
            <a href="community.html" class="nav-link-sidebar">
                <i class="fas fa-users"></i>Community
            </a>
            <a href="chatbot.html" class="nav-link-sidebar">
                <i class="fas fa-comments-dollar"></i>Chat Advisor
            </a>
            <a href="resources.html" class="nav-link-sidebar">
                <i class="fas fa-book-open"></i>Resources
            </a>
            <a href="settings.html" class="nav-link-sidebar">
                <i class="fas fa-cog"></i>Settings
            </a>
            <a href="admin-kyc.html" class="nav-link-sidebar active">
                <i class="fas fa-user-check"></i>KYC Validation
            </a>
        </nav>
        <div class="pb-4">
            <a href="profile.html" class="nav-link-sidebar">
                <i class="fas fa-user-circle"></i>Profile
            </a>
            <a href="#" id="sidebarLogoutLink" class="nav-link-sidebar">
                <i class="fas fa-sign-out-alt"></i>Logout
            </a>
        </div>
    </aside>
    <main class="main-content-area">
        <header class="desktop-header hidden md:flex items-center justify-between mb-8">
            <h1 class="text-3xl font-bold text-gray-800">KYC Validation</h1>
            <div class="flex items-center space-x-3">
                <span id="desktopUserWelcome" class="text-sm text-gray-700">Welcome, Admin!</span>
            </div>
        </header>
        <h1 class="text-2xl font-bold text-gray-800 mb-6 md:hidden">KYC Validation</h1>
        <div class="card-linkedin">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Pending KYC Submissions</h2>
            <div id="usersList" class="space-y-4"></div>
            <div id="userDetails" class="hidden mt-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">User KYC Details</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                        <dt class="text-sm font-medium text-gray-600">Full Name</dt>
                        <dd id="detailFullName" class="text-gray-900"></dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-600">Email</dt>
                        <dd id="detailEmail" class="text-gray-900"></dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-600">Business Name</dt>
                        <dd id="detailBusinessName" class="text-gray-900"></dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-600">ID Number</dt>
                        <dd id="detailIdNumber" class="text-gray-900"></dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-600">ID Document</dt>
                        <dd id="detailIdDocumentUrl" class="text-gray-900"><a href="#" target="_blank" class="text-blue-600 hover:underline">View Document</a></dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-600">KYC Status</dt>
                        <dd id="detailKycStatus" class="text-gray-900"></dd>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button id="approveKyc" class="btn-primary-linkedin">Approve</button>
                    <button id="rejectKyc" class="btn-danger">Reject</button>
                    <button id="requestInfoKyc" class="btn-secondary">Request More Info</button>
                </div>
            </div>
            <div id="messageDiv" class="text-sm text-center font-medium mt-4"></div>
        </div>
    </main>
    <script>
        // Sidebar Toggle
        const hamburgerBtnMobile = document.getElementById('hamburgerBtnMobile');
        const sidebar = document.getElementById('sidebar');
        if (hamburgerBtnMobile && sidebar) {
            hamburgerBtnMobile.addEventListener('click', function(event) {
                event.stopPropagation();
                sidebar.classList.toggle('open');
            });
        }
        document.addEventListener('click', function(event) {
            if (sidebar && sidebar.classList.contains('open') && !sidebar.contains(event.target) && (!hamburgerBtnMobile || !hamburgerBtnMobile.contains(event.target))) {
                sidebar.classList.remove('open');
            }
        });

        // Logout Functionality
        function handleLogout() {
            localStorage.removeItem('nova7Token');
            localStorage.removeItem('nova7User');
            window.location.href = 'login.html';
        }
        const sidebarLogoutLink = document.getElementById('sidebarLogoutLink');
        if (sidebarLogoutLink) {
            sidebarLogoutLink.addEventListener('click', function(event) {
                event.preventDefault();
                handleLogout();
            });
        }
        const mobileLogoutLink = document.getElementById('mobileLogoutLink');
        if (mobileLogoutLink) {
            mobileLogoutLink.addEventListener('click', function(event) {
                event.preventDefault();
                handleLogout();
            });
        }

        // Fetch and Display Pending KYC Users
        document.addEventListener('DOMContentLoaded', async function() {
            const token = localStorage.getItem('nova7Token');
            const messageDiv = document.getElementById('messageDiv');
            const usersList = document.getElementById('usersList');
            const userDetails = document.getElementById('userDetails');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }
            try {
                const response = await fetch('http://127.0.0.1:5005/api/admin/users/pending-validation', {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    usersList.innerHTML = data.users.map(user => `
                        <div class="border-b pb-2">
                            <p class="text-gray-900">${user.fullName} (${user.email})</p>
                            <button class="text-blue-600 hover:underline" onclick="viewUserDetails(${user.id})">View Details</button>
                        </div>
                    `).join('');
                    const user = JSON.parse(localStorage.getItem('nova7User') || '{}');
                    const desktopUserWelcomeElement = document.getElementById('desktopUserWelcome');
                    if (desktopUserWelcomeElement) {
                        desktopUserWelcomeElement.textContent = `Welcome, ${user.fullName || 'Admin'}!`;
                    }
                } else {
                    messageDiv.textContent = data.message || 'Failed to load pending users';
                    messageDiv.classList.add('message-error');
                    if (response.status === 403) handleLogout();
                }
            } catch (error) {
                console.error('Error fetching pending users:', error);
                messageDiv.textContent = 'Error loading pending users. Please try again.';
                messageDiv.classList.add('message-error');
            }
        });

        // View User KYC Details
        async function viewUserDetails(userId) {
            const token = localStorage.getItem('nova7Token');
            const messageDiv = document.getElementById('messageDiv');
            const userDetails = document.getElementById('userDetails');
            try {
                const response = await fetch(`http://127.0.0.1:5005/api/admin/users/${userId}/details`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    const user = data.user;
                    document.getElementById('detailFullName').textContent = user.fullName || 'N/A';
                    document.getElementById('detailEmail').textContent = user.email || 'N/A';
                    document.getElementById('detailBusinessName').textContent = user.businessName || 'N/A';
                    document.getElementById('detailIdNumber').textContent = user.idNumber || 'N/A';
                    const idDocLink = document.getElementById('detailIdDocumentUrl').querySelector('a');
                    idDocLink.href = user.idDocumentUrl || '#';
                    idDocLink.textContent = user.idDocumentUrl ? 'View Document' : 'Not Provided';
                    document.getElementById('detailKycStatus').textContent = user.kycStatus.charAt(0).toUpperCase() + user.kycStatus.slice(1) || 'N/A';
                    userDetails.classList.remove('hidden');
                    // Setup Action Buttons
                    document.getElementById('approveKyc').onclick = () => validateKyc(userId, 'approve');
                    document.getElementById('rejectKyc').onclick = () => validateKyc(userId, 'reject');
                    document.getElementById('requestInfoKyc').onclick = () => validateKyc(userId, 'request_info');
                } else {
                    messageDiv.textContent = data.message || 'Failed to load user details';
                    messageDiv.classList.add('message-error');
                }
            } catch (error) {
                console.error('Error fetching user details:', error);
                messageDiv.textContent = 'Error loading user details. Please try again.';
                messageDiv.classList.add('message-error');
            }
        }

        // Validate KYC
        async function validateKyc(userId, action) {
            const token = localStorage.getItem('nova7Token');
            const messageDiv = document.getElementById('messageDiv');
            try {
                const response = await fetch(`http://127.0.0.1:5005/api/admin/users/${userId}/validate`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action })
                });
                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    messageDiv.textContent = data.message;
                    messageDiv.classList.add('message-success');
                    setTimeout(() => location.reload(), 2000);
                } else {
                    messageDiv.textContent = data.message || `Failed to ${action} KYC`;
                    messageDiv.classList.add('message-error');
                }
            } catch (error) {
                console.error(`Error validating KYC (${action}):`, error);
                messageDiv.textContent = `Error performing ${action}. Please try again.`;
                messageDiv.classList.add('message-error');
            }
        }
    </script>
</body>
</html>
